<!DOCTYPE html>
<html>
<head>
  <title>Marketing Template Editor</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .controls { margin-bottom: 20px; }
    .template-box {
      width: 800px; height: 600px;
      border: 2px dashed #aaa;
      position: relative;
      margin-bottom: 20px;
      background-size: cover;
      background-position: center;
    }
    .draggable, .draggable-text {
      position: absolute;
      cursor: move;
    }
    .draggable-text {
      padding: 5px 10px;
      background: rgba(255,255,255,0.6);
      border: 1px solid #ccc;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h1>Editor</h1>
  <div class="controls">
    <label>Upload Background:</label>
    <input type="file" id="bgInput" accept="image/*"><br><br>

    <label>Upload Foreground:</label>
    <input type="file" id="fgInput" multiple accept="image/*"><br><br>

    <label>Enter Text:</label>
    <input type="text" id="textInput">
    <button onclick="addText()">âž• Add Text</button><br><br>

    <button onclick="downloadTemplate()">ðŸ“¥ Download</button>
  </div>

  <div id="templateBox" class="template-box"></div>

  <h2>Selected Products</h2>
  <div id="selectedGallery">
    {% for img in selected_images %}
      <img src="{{ img }}" width="100" style="cursor:pointer" onclick="addImageToTemplate(this.src)">
    {% endfor %}
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const templateBox = document.getElementById('templateBox');

    document.getElementById('bgInput').addEventListener('change', function(e){
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = evt => templateBox.style.backgroundImage = `url(${evt.target.result})`;
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('fgInput').addEventListener('change', function(e){
      [...e.target.files].forEach(file => {
        const reader = new FileReader();
        reader.onload = evt => addImageToTemplate(evt.target.result);
        reader.readAsDataURL(file);
      });
    });

    function addText(){
      const txt = document.getElementById('textInput').value;
      if(txt.trim()){
        const div = document.createElement('div');
        div.className = "draggable-text";
        div.textContent = txt;
        div.style.left = "50px";
        div.style.top = "50px";
        makeDraggable(div);
        templateBox.appendChild(div);
        document.getElementById('textInput').value = "";
      }
    }

    function addImageToTemplate(src){
      const img = document.createElement('img');
      img.src = src;
      img.className = "draggable";
      img.style.left = "100px";
      img.style.top = "100px";
      img.style.width = "150px";
      makeDraggable(img);
      templateBox.appendChild(img);
    }

    function makeDraggable(el){
      el.onmousedown = function(e){
        let shiftX = e.clientX - el.getBoundingClientRect().left;
        let shiftY = e.clientY - el.getBoundingClientRect().top;

        function moveAt(pageX, pageY){
          el.style.left = pageX - shiftX - templateBox.getBoundingClientRect().left + 'px';
          el.style.top = pageY - shiftY - templateBox.getBoundingClientRect().top + 'px';
        }
        function onMouseMove(e){ moveAt(e.pageX, e.pageY); }

        document.addEventListener('mousemove', onMouseMove);
        el.onmouseup = () => {
          document.removeEventListener('mousemove', onMouseMove);
          el.onmouseup = null;
        }
      };
      el.ondragstart = () => false;
    }

    function downloadTemplate(){
      html2canvas(templateBox).then(canvas => {
        const link = document.createElement('a');
        link.download = "template.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    }
  </script>
</body>
</html>
